<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="凡事以理想为因,实行为过">
<meta property="og:type" content="website">
<meta property="og:title" content="Whole">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Whole">
<meta property="og:description" content="凡事以理想为因,实行为过">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="小鲸鱼">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Whole</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Whole</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/13/FutureTask%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3(2)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/whole.png">
      <meta itemprop="name" content="小鲸鱼">
      <meta itemprop="description" content="凡事以理想为因,实行为过">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whole">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/13/FutureTask%E6%BA%90%E7%A0%81%E7%90%86%E8%A7%A3(2)/" class="post-title-link" itemprop="url">Future体系结构及FutureTask源码理解(2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-13 16:39:56 / 修改时间：18:18:15" itemprop="dateCreated datePublished" datetime="2022-04-13T16:39:56+08:00">2022-04-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JUC/" itemprop="url" rel="index"><span itemprop="name">JUC</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Future的体系结构图"><a href="#Future的体系结构图" class="headerlink" title="Future的体系结构图"></a>Future的体系结构图</h2><img src="http://r95hnmq9s.hn-bkt.clouddn.com/2425.png">


<h2 id="从线程池的submit-方法走进FutureTask"><a href="#从线程池的submit-方法走进FutureTask" class="headerlink" title="从线程池的submit()方法走进FutureTask()"></a>从线程池的submit()方法走进FutureTask()</h2><ul>
<li>引用下<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904177525587981">一枝花算不算浪漫博主的图</a>，将线程池调用submit方法后，FutureTask的执行流程表现的淋漓尽致</li>
</ul>
<img src="http://r95hnmq9s.hn-bkt.clouddn.com/FutureTask.png">

<h2 id="submit-—-gt-execute-方法"><a href="#submit-—-gt-execute-方法" class="headerlink" title="submit()—&gt;execute()方法"></a>submit()—&gt;execute()方法</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractExecutorService</span> <span class="keyword">implements</span> <span class="title class_">ExecutorService</span> &#123;</span><br><span class="line"> <span class="keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Runnable task, T result)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">       RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</span><br><span class="line">       execute(ftask);</span><br><span class="line">       <span class="keyword">return</span> ftask;</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="执行addworker-添加线程数，添加任务，执行任务"><a href="#执行addworker-添加线程数，添加任务，执行任务" class="headerlink" title="执行addworker()添加线程数，添加任务，执行任务"></a>执行addworker()添加线程数，添加任务，执行任务</h2><h2 id="执行runworker-执行任务"><a href="#执行runworker-执行任务" class="headerlink" title="执行runworker()执行任务"></a>执行runworker()执行任务</h2><h2 id="getTask-worker不断去获取同步阻塞队列中的Runnable任务，直到worker中的线程达到了超时时间，那么线程池子运行线程数减一，并在删除worker集合中删除worker-在processWorkerExit-方法中"><a href="#getTask-worker不断去获取同步阻塞队列中的Runnable任务，直到worker中的线程达到了超时时间，那么线程池子运行线程数减一，并在删除worker集合中删除worker-在processWorkerExit-方法中" class="headerlink" title="getTask()worker不断去获取同步阻塞队列中的Runnable任务，直到worker中的线程达到了超时时间，那么线程池子运行线程数减一，并在删除worker集合中删除worker(在processWorkerExit()方法中)"></a>getTask()worker不断去获取同步阻塞队列中的Runnable任务，直到worker中的线程达到了超时时间，那么线程池子运行线程数减一，并在删除worker集合中删除worker(在processWorkerExit()方法中)</h2><h2 id="task-run-执行任务—-gt-FutureTask-task被包装成了FutureTask，所以执行的是FutureTask-run"><a href="#task-run-执行任务—-gt-FutureTask-task被包装成了FutureTask，所以执行的是FutureTask-run" class="headerlink" title="task.run();执行任务—-&gt; FutureTask      (task被包装成了FutureTask，所以执行的是FutureTask.run())"></a>task.run();执行任务—-&gt; FutureTask      (task被包装成了FutureTask，所以执行的是FutureTask.run())</h2><h2 id="FutureTask成员变量解析"><a href="#FutureTask成员变量解析" class="headerlink" title="FutureTask成员变量解析"></a>FutureTask成员变量解析</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> * Possible state transitions:</span><br><span class="line">    * NEW -&gt; COMPLETING -&gt; NORMAL</span><br><span class="line">    * NEW -&gt; COMPLETING -&gt; EXCEPTIONAL</span><br><span class="line">    * NEW -&gt; CANCELLED</span><br><span class="line">    * NEW -&gt; INTERRUPTING -&gt; INTERRUPTED</span><br><span class="line">    */</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NEW</span>          <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//新建状态,任务尚未执行</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COMPLETING</span>   <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//任务正在结束，临界状态</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NORMAL</span>       <span class="operator">=</span> <span class="number">2</span>;<span class="comment">//任务正常执行完毕</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCEPTIONAL</span>  <span class="operator">=</span> <span class="number">3</span>;<span class="comment">//任务执行中出现异常</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span>    <span class="operator">=</span> <span class="number">4</span>;<span class="comment">//任务被取消</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTING</span> <span class="operator">=</span> <span class="number">5</span>;<span class="comment">//任务中断中</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTED</span>  <span class="operator">=</span> <span class="number">6</span>;<span class="comment">//任务被中断</span></span><br><span class="line"></span><br><span class="line">状态的转移，注释上说的很清楚了，<span class="number">7</span>中状态中比较难理解的就是COMPLETING，INTERRUPTING可以认为是一种临界状态</span><br><span class="line">其余五种状态根据英文很容易得出是什么意义</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户自定义的callable()对象</span></span><br><span class="line"> <span class="keyword">private</span> Callable&lt;V&gt; callable;</span><br><span class="line">   <span class="comment">//保存正常输出结果，或者异常信息</span></span><br><span class="line">   <span class="keyword">private</span> Object outcome; </span><br><span class="line">   <span class="comment">//当前任务被线程执行期间，保存当前任务的线程对象引用</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> Thread runner;</span><br><span class="line">   <span class="comment">//Treiber 堆栈中记录等待线程的简单链表节点</span></span><br><span class="line"><span class="comment">//为什么会设置一个stack的方式来存储等待线程呢?因为会有很多线程去get当前任务的结果，所以这里使用了一种stack数据结构来保存</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> WaitNode waiters;</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">	static final class WaitNode &#123;</span></span><br><span class="line"><span class="comment">       volatile Thread thread;</span></span><br><span class="line"><span class="comment">       volatile WaitNode next;</span></span><br><span class="line"><span class="comment">       WaitNode() &#123; thread = Thread.currentThread(); &#125;</span></span><br><span class="line"><span class="comment">   &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="FutureTask-调用run方法"><a href="#FutureTask-调用run方法" class="headerlink" title="FutureTask()调用run方法"></a>FutureTask()调用run方法</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	 <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//如果状态不是 NEW，说明任务已经执行过或者已经被取消，直接返回</span></span><br><span class="line">		<span class="comment">//尝试将当前执行线程保存在 runnerOffset（runner字段），失败则返回</span></span><br><span class="line">        <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">            !UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, runnerOffset,</span><br><span class="line">                                         <span class="literal">null</span>, Thread.currentThread()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//用户自定义的Callable对象</span></span><br><span class="line">            Callable&lt;V&gt; c = callable;</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">                V result;</span><br><span class="line">                <span class="type">boolean</span> ran;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">//执行call任务保存结果</span></span><br><span class="line">                    result = c.call();</span><br><span class="line">                    ran = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                    result = <span class="literal">null</span>;</span><br><span class="line">                    ran = <span class="literal">false</span>;</span><br><span class="line">					<span class="comment">//出现异常保存异常信息</span></span><br><span class="line">                    setException(ex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (ran)</span><br><span class="line">                    set(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// runner must be non-null until state is settled to</span></span><br><span class="line">            <span class="comment">// prevent concurrent calls to run()</span></span><br><span class="line">            runner = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// state must be re-read after nulling runner to prevent</span></span><br><span class="line">            <span class="comment">// leaked interrupts</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">			<span class="comment">//执行中断处理</span></span><br><span class="line">            <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">                handlePossibleCancellationInterrupt(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">## setException()，set()方法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	```Java</span><br><span class="line">	</span><br><span class="line">	 <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(V v)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">            outcome = v;</span><br><span class="line">            UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, NORMAL); <span class="comment">// final state</span></span><br><span class="line">            finishCompletion();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setException</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">            outcome = t;</span><br><span class="line">			<span class="comment">//修改状态值</span></span><br><span class="line">            UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, EXCEPTIONAL); <span class="comment">// final state</span></span><br><span class="line">			<span class="comment">//唤醒调用get()方法阻塞的线程</span></span><br><span class="line">            finishCompletion();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	全局变量outcome保存执行结果或者异常信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904177525587981">一枝花算不算浪漫博主的图</a><br><img src="http://r95hnmq9s.hn-bkt.clouddn.com/34423.png"></p>
<h2 id="FutureTask中get-方法"><a href="#FutureTask中get-方法" class="headerlink" title="FutureTask中get()方法"></a>FutureTask中get()方法</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">	<span class="comment">//获取任务的状态</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">	<span class="comment">//要么是新建要么是正在执行(任务没有完成那么就阻塞等待)</span></span><br><span class="line">       <span class="keyword">if</span> (s &lt;= COMPLETING)</span><br><span class="line">		<span class="comment">//阻塞等待方法</span></span><br><span class="line">           s = awaitDone(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">	<span class="comment">//返回结果或者抛出信息</span></span><br><span class="line">       <span class="keyword">return</span> report(s);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="FutureTask中最核心的方法awaitDone-false-0L"><a href="#FutureTask中最核心的方法awaitDone-false-0L" class="headerlink" title="FutureTask中最核心的方法awaitDone(false, 0L)"></a>FutureTask中最核心的方法awaitDone(false, 0L)</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//get()方法可以超时等待，接受的参数是 false 和 0L</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">awaitDone</span><span class="params">(<span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">	<span class="comment">//是否运行超时等待</span></span><br><span class="line">       <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">	<span class="comment">//获取任务阻塞的线程包装类</span></span><br><span class="line">       <span class="type">WaitNode</span> <span class="variable">q</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="type">boolean</span> <span class="variable">queued</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="comment">//如果当前线程被中断，那么就珊瑚档期那线程，抛出异常</span></span><br><span class="line">           <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">               removeWaiter(q);</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">           &#125;</span><br><span class="line">		<span class="comment">//获取任务运行状态</span></span><br><span class="line">           <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">           <span class="keyword">if</span> (s &gt; COMPLETING) &#123;</span><br><span class="line">               <span class="keyword">if</span> (q != <span class="literal">null</span>)</span><br><span class="line">                   q.thread = <span class="literal">null</span>;</span><br><span class="line">               <span class="keyword">return</span> s;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING)</span><br><span class="line">               Thread.yield();</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="literal">null</span>)</span><br><span class="line">               q = <span class="keyword">new</span> <span class="title class_">WaitNode</span>();</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (!queued)</span><br><span class="line">               queued = UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, waitersOffset, q.next = waiters, q);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">			<span class="comment">//deadline为当前线程能够等待的时间 </span></span><br><span class="line">			<span class="comment">//System.nanoTime()为当前时间</span></span><br><span class="line">               nanos = deadline - System.nanoTime();</span><br><span class="line">			<span class="comment">//说明超时那么移除当前结点</span></span><br><span class="line">               <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                   removeWaiter(q);</span><br><span class="line">                   <span class="keyword">return</span> state;</span><br><span class="line">               &#125;</span><br><span class="line">               LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">               LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<p>1.<b> if (s &gt; COMPLETING) {} 说明当前任务以及执行完，无论是正常返回的结果，还是异常、中断、取消等，返回状态执行report()方法</b></p>
<ol start="2">
<li><p>else if (s &#x3D;&#x3D; COMPLETING)说明当前任务正在结束，那么就让出cpu执行权</p>
</li>
<li><p>else if (q &#x3D;&#x3D; null)第一次进入循环，初始化WaitNode</p>
</li>
<li><p>else if (!queued) 代表当前线程是否入栈，如果没有入栈则进行入栈操作，顺便将全局变量waiters指向栈顶元素。(waiters指向栈的头结点)</p>
</li>
<li><p>else if (timed) {}如果当前线程超时等待那么调用LockSupport.parkNanos(this, nanos)方法</p>
</li>
<li><p>else 没有设置超时等待那么调用LockSupport.park(this);方法</p>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904177525587981">一枝花算不算浪漫博主的图</a><br><img src="http://r95hnmq9s.hn-bkt.clouddn.com/stack.png"></p>
<h2 id="run方法运行完之后就调用唤醒线程方法-finishCompletion"><a href="#run方法运行完之后就调用唤醒线程方法-finishCompletion" class="headerlink" title="run方法运行完之后就调用唤醒线程方法 finishCompletion()"></a>run方法运行完之后就调用唤醒线程方法 finishCompletion()</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    * Removes and signals all waiting threads, invokes <span class="title function_">done</span><span class="params">()</span>, and</span><br><span class="line">    * nulls out callable.(删除所有等待的线程并发出信号，调用 done()，并且将可调用对象设为空)</span><br><span class="line">    <span class="comment">//最好的学习方式就是看注释</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finishCompletion</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// assert state &gt; COMPLETING;</span></span><br><span class="line">       <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="literal">null</span>;) &#123;</span><br><span class="line">           <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, waitersOffset, q, <span class="literal">null</span>)) &#123;</span><br><span class="line">               <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                   <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> q.thread;</span><br><span class="line">                   <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                       q.thread = <span class="literal">null</span>;</span><br><span class="line">                       LockSupport.unpark(t);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="type">WaitNode</span> <span class="variable">next</span> <span class="operator">=</span> q.next;</span><br><span class="line">                   <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   q.next = <span class="literal">null</span>; <span class="comment">// unlink to help gc</span></span><br><span class="line">                   q = next;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       done();</span><br><span class="line"></span><br><span class="line">       callable = <span class="literal">null</span>;        <span class="comment">// to reduce footprint</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">方法整体逻辑比较简单，因为所有等待的线程保存在stack里，那么我们通过waiters.next就能依此遍历所有节点</span><br><span class="line">然后进行唤醒，唤醒后的节点接着会往后调用report()方法。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="report"><a href="#report" class="headerlink" title="report()"></a>report()</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">report</span><span class="params">(<span class="type">int</span> s)</span> <span class="keyword">throws</span> ExecutionException &#123;</span><br><span class="line">   <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> outcome;</span><br><span class="line">   <span class="keyword">if</span> (s == NORMAL)</span><br><span class="line">       <span class="keyword">return</span> (V)x;</span><br><span class="line">   <span class="keyword">if</span> (s &gt;= CANCELLED)</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CancellationException</span>();</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutionException</span>((Throwable)x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">该方法的整体逻辑很简单，就是判断运行状态然后返回不同的结果值</span><br></pre></td></tr></table></figure>
</code></pre>

      
    </div>

    
    
    
	
	
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/13/%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84Demo%E6%BC%94%E7%A4%BAmd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/whole.png">
      <meta itemprop="name" content="小鲸鱼">
      <meta itemprop="description" content="凡事以理想为因,实行为过">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whole">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/13/%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84Demo%E6%BC%94%E7%A4%BAmd/" class="post-title-link" itemprop="url">创建线程的几种方式及代码演示(1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-13 10:37:00 / 修改时间：14:19:29" itemprop="dateCreated datePublished" datetime="2022-04-13T10:37:00+08:00">2022-04-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JUC/" itemprop="url" rel="index"><span itemprop="name">JUC</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h2><pre><code>``Java
    
import java.util.concurrent.*;

public class ThreadDemo &#123;
    public static void main(String[] args) throws InterruptedException, ExecutionException &#123;
        System.out.println(&quot;-------------------------继承Thread类来创建线程 --------------------------------&quot;);
        PrintAB pb = new PrintAB(1);
        new Thread(()-&gt;&#123;
            pb.printA();
        &#125;,&quot;A&quot;).start();
        new Thread(()-&gt;&#123;
            pb.printB();
        &#125;,&quot;A&quot;).start();
        Thread.sleep(500);
        System.out.println(&quot;-------------------------使用Runnable创建线程--------------------------------&quot;);
        //直接使用Runnable接口实现类来创建线程
        RunnableDemo rd = new RunnableDemo();
        new Thread(rd,&quot;rd_A&quot;).start();
        new Thread(rd,&quot;rd_B&quot;).start();
        //配合线程池来使用(为了方便直接使用Executors来创建线程池，但是不建议使用因为等待队列是无界队列使用不当容易造成内存溢出)
        Thread.sleep(500);
        System.out.println(&quot;-------------------------Runnable配合线程池使用(execute)--------------------------------&quot;);
        ExecutorService es = Executors.newFixedThreadPool(2);
        es.execute(rd);
        //配合线程池使用submit方法
        //execute只能提交Runnable类型的任务，无返回值。submit既可以提交Runnable类型的任务，也可以提交Callable类型的任务，会有一个类型为Future的返回值，但当任务类型为Runnable时，返回值为null。
        Thread.sleep(500);
        System.out.println(&quot;-------------------------Runnable配合线程池使用(submit)--------------------------------&quot;);
        Future&lt;?&gt; submit = es.submit(rd);
        System.out.println(&quot;Runnable的返回值为 :&quot;+submit.get());
        System.out.println(&quot;-------------------------Callable配合线程池使用--------------------------------&quot;);
        //为了方便直接使用内部类来声明Callable的实现类
        Thread.sleep(500);
        Future&lt;String&gt; submit1 = es.submit(new Callable&lt;String&gt;() &#123;
            @Override
            public String call() throws Exception &#123;
                for (int i = 0; i &lt; 7; i++) &#123;
                    System.out.println(Thread.currentThread().getName() + &quot;正在打印 :&quot; + (i + 1));
                &#125;
                return &quot;Callable打印完成&quot;;
            &#125;
        &#125;);
        System.out.println(&quot;Callable的返回值为 :&quot;+submit1.get());
    &#125;
    &#125;
    class PrintAB extends Thread&#123;
    int ctl;
    public PrintAB(int ctl)&#123;
        this.ctl = ctl;
    &#125;

    public void printA()&#123;
        for(int i=1;i&lt;=7;i++)&#123;
            synchronized (this)&#123;
                while(ctl!=1)&#123;
                    try &#123;
                        wait();
                    &#125; catch (InterruptedException e) &#123;
                        e.printStackTrace();
                    &#125;
                &#125;
                System.out.println(&quot;线程A正在打印数字 ：&quot;+i);
                ctl = 2;
                notifyAll();
            &#125;
        &#125;
    &#125;

    public void printB()&#123;
        for(int i=1;i&lt;=7;i++)&#123;
            synchronized (this)&#123;
                while(ctl!=2)&#123;
                    try &#123;
                        wait();
                    &#125; catch (InterruptedException e) &#123;
                        e.printStackTrace();
                    &#125;
                &#125;
                System.out.println(&quot;线程B正在打印数字 ：&quot;+i);
                ctl = 1;
                notifyAll();
            &#125;

        &#125;
    &#125;
    &#125;
    class RunnableDemo implements Runnable&#123;
    @Override
    public void run() &#123;
        for(int i=0;i&lt;7;i++)&#123;
            System.out.println(Thread.currentThread().getName()+&quot;正在打印 :&quot;+(i+1));
        &#125;
    &#125;
    &#125;
    es.shutdownNow();

---
</code></pre>
<p>&#96;&#96;</p>
<ul>
<li>Runnable和Callable的区别  <ul>
<li>Runnable没有返回值，Callable有返回值</li>
<li>Runnable没法抛出异常(public abstract void run()),Callable能抛出异常(V call() throws Exception;)</li>
<li>Runnable接口的实现类能直接配合Thread类使用，而Callable不能</li>
</ul>
</li>
</ul>
<h2 id="结果演示"><a href="#结果演示" class="headerlink" title="结果演示"></a>结果演示</h2><pre><code>``Java
    -------------------------继承Thread类来创建线程 --------------------------------
线程A正在打印数字 ：1
线程B正在打印数字 ：1
线程A正在打印数字 ：2
线程B正在打印数字 ：2
线程A正在打印数字 ：3
线程B正在打印数字 ：3
线程A正在打印数字 ：4
线程B正在打印数字 ：4
线程A正在打印数字 ：5
线程B正在打印数字 ：5
线程A正在打印数字 ：6
线程B正在打印数字 ：6
线程A正在打印数字 ：7
线程B正在打印数字 ：7
-------------------------使用Runnable创建线程--------------------------------
rd_A正在打印 :1
rd_A正在打印 :2
rd_A正在打印 :3
rd_B正在打印 :1
rd_B正在打印 :2
rd_B正在打印 :3
rd_B正在打印 :4
rd_B正在打印 :5
rd_B正在打印 :6
rd_B正在打印 :7
rd_A正在打印 :4
rd_A正在打印 :5
rd_A正在打印 :6
rd_A正在打印 :7
-------------------------Runnable配合线程池使用(execute)--------------------------------
pool-1-thread-1正在打印 :1
pool-1-thread-1正在打印 :2
pool-1-thread-1正在打印 :3
pool-1-thread-1正在打印 :4
pool-1-thread-1正在打印 :5
pool-1-thread-1正在打印 :6
pool-1-thread-1正在打印 :7
-------------------------Runnable配合线程池使用(submit)--------------------------------
pool-1-thread-2正在打印 :1
pool-1-thread-2正在打印 :2
pool-1-thread-2正在打印 :3
pool-1-thread-2正在打印 :4
pool-1-thread-2正在打印 :5
pool-1-thread-2正在打印 :6
pool-1-thread-2正在打印 :7
Runnable的返回值为 :null
-------------------------Callable配合线程池使用(submit)--------------------------------
pool-1-thread-1正在打印 :1
pool-1-thread-1正在打印 :2
pool-1-thread-1正在打印 :3
pool-1-thread-1正在打印 :4
pool-1-thread-1正在打印 :5
pool-1-thread-1正在打印 :6
pool-1-thread-1正在打印 :7
Callable的返回值为 :Callable打印完成

Process finished with exit code 0
</code></pre>
<p>&#96;&#96;</p>

      
    </div>

    
    
    
	
	
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/28/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3(ThreadPoolExecutor)(2)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/whole.png">
      <meta itemprop="name" content="小鲸鱼">
      <meta itemprop="description" content="凡事以理想为因,实行为过">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whole">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/28/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3(ThreadPoolExecutor)(2)/" class="post-title-link" itemprop="url">线程池源码详解(ThreadPoolExecutor)(2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-28 18:04:15" itemprop="dateCreated datePublished" datetime="2022-03-28T18:04:15+08:00">2022-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-13 17:05:29" itemprop="dateModified" datetime="2022-04-13T17:05:29+08:00">2022-04-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JUC/" itemprop="url" rel="index"><span itemprop="name">JUC</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>17 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="THREADPOOLEXECUTOR成员变量及内部类WORKER的属性详解"><a href="#THREADPOOLEXECUTOR成员变量及内部类WORKER的属性详解" class="headerlink" title="THREADPOOLEXECUTOR成员变量及内部类WORKER的属性详解"></a>THREADPOOLEXECUTOR成员变量及内部类WORKER的属性详解</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">主池控制状态，ctl，是一个原子整数包装两个概念字段workerCount，有效线程数runState，线程池状态</span></span><br><span class="line"><span class="comment">	(1):1：workerCount 线程池种有效线程数  2: runState 运行状态 例如运行 ，关闭等</span></span><br><span class="line"><span class="comment">为了将它们打包到一个 int 中，我们将 workerCount 限制为 (2^29)-1（大约 5 亿）个线程，而不是 (2^31)-1 (十亿) 个线程，workerCount占用低29位，runState占用高三位</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="comment">//线程数容量，低29位表示有效线程数，0001,1111,1111,1111,1111,1111,1111,1111</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAPACITY</span>   <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line">       运行状态(从小到大)</span><br><span class="line">   <span class="number">1110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> 运行 -<span class="number">1</span> &lt;&lt; COUNT_BITS</span><br><span class="line">   <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> 关闭 <span class="number">0</span> &lt;&lt; COUNT_BITS</span><br><span class="line">	   <span class="number">0010</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> 停止 <span class="number">1</span> &lt;&lt; COUNT_BITS</span><br><span class="line"> 	   <span class="number">0100</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> 整理 <span class="number">2</span> &lt;&lt; COUNT_BITS</span><br><span class="line">	   <span class="number">0110</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> 终止 <span class="number">3</span> &lt;&lt; COUNT_BITS</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;<span class="comment">//接受新任务并处理排队的任务</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;<span class="comment">//不接受新任务，但处理排队的任务</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;<span class="comment">//不接受新任务，不处理排队的任务，并中断正在进行的任务</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;<span class="comment">//所有任务都已终止，workerCount 为零， 转换到状态 TIDYING 的线程 将运行 terminate() 钩子方法</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;<span class="comment">//终止已完成</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 获取Ctl高三位也即是运行时状态</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line"><span class="comment">//获取Ctl低29位也即是有效线程数</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"><span class="comment">//得到ctl值，高三位与低29位或运算</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment">//判断运行时状态的大小</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateLessThan</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> c &lt; s;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateAtLeast</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> c &gt;= s;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//判断线程池是否处于运行状态，因为比SHUTDOWN小的只有Running</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">(<span class="type">int</span> c)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> c &lt; SHUTDOWN;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//以CAS的方式增加有效线程数(WorkerCount)</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndIncrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> ctl.compareAndSet(expect, expect + <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//以CAS的方式减少有效线程数</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndDecrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> ctl.compareAndSet(expect, expect - <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ctl 的 workerCount 字段减一。这仅在线程突然终止时调用</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">decrementWorkerCount</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (! compareAndDecrementWorkerCount(ctl.get()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//工作队列</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//基于AQS实现的Lock锁</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//包含池中所有工作线程的集合。仅在 持有 mainLock 时访问,worker集合</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//支持 awaitTermination 的等待条件</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">termination</span> <span class="operator">=</span> mainLock.newCondition();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//跟踪获得的最大池大小。只能在 mainLock 下访问。</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> largestPoolSize;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//已完成任务的计数器(总的完成线程数)。仅在终止工作线程时更新。只能在 mainLock 下访问</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">long</span> completedTaskCount;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//线程工厂</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;</span><br><span class="line">	</span><br><span class="line"><span class="comment">//拒绝策略</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//空闲线程的超市时间</span></span><br><span class="line"><span class="comment">//核心线程是否回收与allowCoreThreadTimeOut()方法有关，当位true时，核心线程使用完也会一同会被回收，默认缺省值为false</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> keepAliveTime;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//是否允许核心线程超时，默认false，false情况下核心线程会一直存活。</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> allowCoreThreadTimeOut;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//核心线程的数量</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> corePoolSize;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//最大线程数</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> maximumPoolSize;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//默认的拒绝策略,直接抛异常</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RejectedExecutionHandler</span> <span class="variable">defaultHandler</span> <span class="operator">=</span></span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">AbortPolicy</span>();</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RuntimePermission</span> <span class="variable">shutdownPerm</span> <span class="operator">=</span></span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">RuntimePermission</span>(<span class="string">&quot;modifyThread&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//Worker类，每个Worker包含一个线程、一个初始任务、一个任务计算器</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span></span><br><span class="line">       <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span></span><br><span class="line">       <span class="keyword">implements</span> <span class="title class_">Runnable</span></span><br><span class="line">   &#123;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6138294804551838833L</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//Worker对应的线程</span></span><br><span class="line">       <span class="keyword">final</span> Thread thread;</span><br><span class="line">       <span class="comment">//初始任务(当前线程首先需要执行的任务)</span></span><br><span class="line">       Runnable firstTask;</span><br><span class="line">       <span class="comment">//线程任务计数器(当前worker执行成功的任务数)</span></span><br><span class="line">       <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       Worker(Runnable firstTask) &#123;</span><br><span class="line">           setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">           <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">           <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//将主运行循环委托给外部 runWorker</span></span><br><span class="line">           runWorker(<span class="built_in">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">	<span class="comment">//通过AQS的同步状态来实现锁机制。state为0时代表锁未被获取（解锁状态），</span></span><br><span class="line">    	state为<span class="number">1</span>时代表锁已经被获取（加锁状态）。</span><br><span class="line">       <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> getState() != <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">	<span class="comment">//尝试获取锁</span></span><br><span class="line">       <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">               setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">	<span class="comment">//尝试释放锁</span></span><br><span class="line">       <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">           setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">           setState(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">	</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>        &#123; acquire(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>  &#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>      &#123; release(<span class="number">1</span>); &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span> &#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</span><br><span class="line">	<span class="comment">//确保线程已经运行并且中断标志为还是false时，就执行中断操作。</span></span><br><span class="line">       <span class="keyword">void</span> <span class="title function_">interruptIfStarted</span><span class="params">()</span> &#123;</span><br><span class="line">           Thread t;</span><br><span class="line">           <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="literal">null</span> &amp;&amp; !t.isInterrupted()) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   t.interrupt();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="线程池核心方法execute方法"><a href="#线程池核心方法execute方法" class="headerlink" title="线程池核心方法execute方法"></a>线程池核心方法execute方法</h2><ul>
<li>execute()方法执行流程</li>
</ul>
<ol>
<li>如果当前运行的线程少于核心线程数corePoolSize，则创建新线程来执行任务</li>
<li>当前运行的线程大于等于核心线程池数，那么就放入阻塞队列中去</li>
<li>阻塞队列已满那么就创建一个线程去执行</li>
<li>如果创建新线程使当前总线程数超过最大线程数maximumPoolSize，任务将被拒绝，线程池拒绝策略handler执行</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">      <span class="comment">//获取当前线程池的ctl值</span></span><br><span class="line">      <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line"><span class="comment">//当前线程池有效线程数少于核心线程数</span></span><br><span class="line">      <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">	<span class="comment">//addWorker()方法可以分为增加线程数、添加任务，并执行</span></span><br><span class="line">          <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          c = ctl.get();</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//isRunning()获取当前线程池是否处于运行状态,并且将其加入到阻塞队列中</span></span><br><span class="line">      <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">	<span class="comment">//双重检查机制</span></span><br><span class="line">	<span class="comment">//目的:检查是否真的需要添加一个线程，防止因为并发情况，导致线程池已经关闭，那么就不需要再创建线程</span></span><br><span class="line">          <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">	<span class="comment">//如果当前线程池不处于运行状态，并且将任务从阻塞队列中删除成功，则任务由RejectedExecutionHandler处理</span></span><br><span class="line">          <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">              reject(command);</span><br><span class="line">	<span class="comment">//如果当前线程池中有效线程数为空，那么就创建一个新的线程去执行</span></span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">              addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//执行到这步，那么只有当有效线程数小于最大线程数，并且阻塞队列已满，那么就尝试创建一个线程去执行，</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">	<span class="comment">//执行拒绝策略</span></span><br><span class="line">          reject(command);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/03/28/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3(ThreadPoolExecutor)(2)/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
	
	
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/22/KMP%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/whole.png">
      <meta itemprop="name" content="小鲸鱼">
      <meta itemprop="description" content="凡事以理想为因,实行为过">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whole">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/22/KMP%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">KMP算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-22 18:04:15" itemprop="dateCreated datePublished" datetime="2022-03-22T18:04:15+08:00">2022-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-08 09:32:55" itemprop="dateModified" datetime="2022-04-08T09:32:55+08:00">2022-04-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="KMP算法是用来解决字符串匹配问题的，解决字符串匹配问题主要有两种方法"><a href="#KMP算法是用来解决字符串匹配问题的，解决字符串匹配问题主要有两种方法" class="headerlink" title="KMP算法是用来解决字符串匹配问题的，解决字符串匹配问题主要有两种方法"></a>KMP算法是用来解决字符串匹配问题的，解决字符串匹配问题主要有两种方法</h2><h3 id="第一种-使用暴力枚举法，穷举出所有的可能，进行判断，时间复杂度为Log-M-N"><a href="#第一种-使用暴力枚举法，穷举出所有的可能，进行判断，时间复杂度为Log-M-N" class="headerlink" title="第一种: 使用暴力枚举法，穷举出所有的可能，进行判断，时间复杂度为Log(M*N)"></a>第一种: 使用暴力枚举法，穷举出所有的可能，进行判断，时间复杂度为Log(M*N)</h3><h3 id="第二种：使用KMP算法，使得时间复杂度能够将为线性"><a href="#第二种：使用KMP算法，使得时间复杂度能够将为线性" class="headerlink" title="第二种：使用KMP算法，使得时间复杂度能够将为线性"></a>第二种：使用KMP算法，使得时间复杂度能够将为线性</h3><ul>
<li>以力扣原题<a target="_blank" rel="noopener" href="https://leetcode-cn.com/problems/implement-strstr/">力扣28题</a>为例，该题就是一个典型的KMP算法使用例子</li>
</ul>
<h1 id="暴力枚举法-穷举出所有的可能进行判断，时间复杂度为Log-M-N"><a href="#暴力枚举法-穷举出所有的可能进行判断，时间复杂度为Log-M-N" class="headerlink" title="暴力枚举法(穷举出所有的可能进行判断，时间复杂度为Log(M*N))"></a>暴力枚举法(穷举出所有的可能进行判断，时间复杂度为Log(M*N))</h1><p> &#96;&#96;Java</p>
<pre><code>class Solution &#123;
public int strStr(String haystack, String needle) &#123;
    int n = haystack.length(), m = needle.length();
    for (int i = 0; i + m &lt;= n; i++) &#123;
        boolean flag = true;
        for (int j = 0; j &lt; m; j++) &#123;
            if (haystack.charAt(i + j) != needle.charAt(j)) &#123;
                flag = false;
                break;
            &#125;
        &#125;
        if (flag) &#123;
            return i;
        &#125;
    &#125;
    return -1;
 &#125;
&#125;

``
</code></pre>
<h2 id="KMP算法解决字符串匹配问题"><a href="#KMP算法解决字符串匹配问题" class="headerlink" title="KMP算法解决字符串匹配问题"></a>KMP算法解决字符串匹配问题</h2><p>###要理解KMP算法，必须要知道几个概念</p>
<ul>
<li><p>KMP如何做到线性的时间复杂度，使用KMP算法当出现字符串不匹配时，我们可以知道一部分之前已经匹配的文本内容，从而避免了从头匹配的过程</p>
</li>
<li><p>要做到知道之前已经匹配的文本内容，我们必须知道几个概念</p>
<ul>
<li>字符串前缀: 不包含最后一个字符的所有以第一个字符开头的连续子串。(例如aabaaf中连续子串有a,aa,aab,aaba,aabaa) </li>
<li>字符串后缀: 不包含第一个字符的所有以最后一个字符结尾的连续子串。(例如aabaaf中连续子串有f,af,aaf,baaf,abaaf)</li>
</ul>
</li>
<li><p>前缀表也即是next数组，next数组的含义为当模式串与主串(文本串)不匹配的时候，模式串应该从哪里开始重新匹配。</p>
<ul>
<li>例如文本串aabaabaafa与模式串aabaaf，显然在第一次匹配的时候在文本串aabaab中b字符与模式串aabaaf中f字符不相等，如果是暴力枚举法的话需要将文本串指针指向，向后移动一位继续匹配，在使用了KMP算法后我们可以使用前缀表来得出模式串应该从哪里开始重新匹配，为什么从前缀表就可以得出模式串应该从哪里开始重新匹配呢？<ul>
<li>前缀表其实记录的就是最长相等前后缀的长度，例如aabaa中最长相等前后缀的长度为2(也即是aa)，还是上面文本串和模式串的例子，在第一次不匹配的时候我们可以查看模式串不匹配字符前的最长相等前后缀(aa),那么我们就可以变相的将该串的前缀子串移动到已匹配的后缀子串的位置(只是模式串匹配指针的移动，从而可以看成变相的导致前缀子串的移动)，从而避免了暴力枚举中重复匹配的过程(在当前例子中也即是从b字符继续匹配)</li>
</ul>
</li>
</ul>
</li>
<li><p>前缀表的求解也即是next数组的求解</p>
</li>
</ul>
<p> &#96;&#96;Java</p>
<pre><code>public void getNext(int[] next,String tar)&#123;
    int j = 0;
    next[0] = 0;
    for(int i=1;i&lt;tar.length();i++)&#123;
        while(j&gt;0&amp;&amp;tar.charAt(i)!=tar.charAt(j))&#123;
             j = next[j-1];
        &#125;
        if(tar.charAt(i)==tar.charAt(j))&#123;
            j++;
        &#125;
        next[i] = j;
    &#125;
&#125;
</code></pre>
<p>&#96;&#96;</p>
<ol>
<li>next数组的求解可以分为三步 第一步next数组初始化</li>
<li>第二步 处理前后缀不同的情况</li>
<li>第三步 处理前后缀相同的情况</li>
</ol>
<p> &#96;&#96;Java</p>
<pre><code>class Solution &#123;
public int strStr(String haystack, String needle) &#123;
     if (needle.length() == 0) &#123;//边界判断
        return 0;
    &#125;
     int []next = new int[needle.length()];//前缀表也可以说是next数组
     getNext(next,needle);
     int j = 0;
     for(int i=0;i&lt;haystack.length();i++)&#123;
        while(j&gt;0&amp;&amp;(haystack.charAt(i)!=needle.charAt(j)))&#123;
            j = next[j-1];
        &#125;
        if(haystack.charAt(i)==needle.charAt(j))&#123;
            j++;
        &#125;
        if(j==needle.length())&#123;
           return i-needle.length()+1;
        &#125;
     &#125;
     return -1;
&#125;
public void getNext(int[] next,String tar)&#123;
    int j = 0;
    next[0] = 0;
    for(int i=1;i&lt;tar.length();i++)&#123;
        while(j&gt;0&amp;&amp;tar.charAt(i)!=tar.charAt(j))&#123;
             j = next[j-1];
        &#125;
        if(tar.charAt(i)==tar.charAt(j))&#123;
            j++;
        &#125;
        next[i] = j;
    &#125;
&#125;

&#125;
</code></pre>
<p>&#96;&#96;</p>
<h3 id="最后附上几张图帮助理解以下图均来自代码随想录"><a href="#最后附上几张图帮助理解以下图均来自代码随想录" class="headerlink" title="最后附上几张图帮助理解以下图均来自代码随想录"></a>最后附上几张图帮助理解<a target="_blank" rel="noopener" href="https://www.programmercarl.com/">以下图均来自代码随想录</a></h3><img src="http://r95hnmq9s.hn-bkt.clouddn.com/2341.png">
<iframe height="500" width="500" src="http://r95hnmq9s.hn-bkt.clouddn.com/2342.gif">
</iframe>
      
    </div>

    
    
    
	
	
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/22/AQS%E6%BA%90%E7%A0%81-%E5%86%85%E9%83%A8%E7%B1%BBCondition%E7%9A%84%E7%90%86%E8%A7%A3(3)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/whole.png">
      <meta itemprop="name" content="小鲸鱼">
      <meta itemprop="description" content="凡事以理想为因,实行为过">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whole">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/22/AQS%E6%BA%90%E7%A0%81-%E5%86%85%E9%83%A8%E7%B1%BBCondition%E7%9A%84%E7%90%86%E8%A7%A3(3)/" class="post-title-link" itemprop="url">AQS源码-内部类Condition条件队列(3)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-22 18:04:15" itemprop="dateCreated datePublished" datetime="2022-03-22T18:04:15+08:00">2022-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-07 21:04:15" itemprop="dateModified" datetime="2022-04-07T21:04:15+08:00">2022-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JUC/" itemprop="url" rel="index"><span itemprop="name">JUC</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>先看一下同步队列,条件队列，同步器三者的关系结构图(该图来自<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/163621874">https://zhuanlan.zhihu.com/p/163621874</a>)</li>
</ul>
<img src="http://r95hnmq9s.hn-bkt.clouddn.com/condition.png">


<h2 id="AQS中实现Condition接口的内部类ConditionObject"><a href="#AQS中实现Condition接口的内部类ConditionObject" class="headerlink" title="AQS中实现Condition接口的内部类ConditionObject"></a>AQS中实现Condition接口的内部类ConditionObject</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionObject</span> <span class="keyword">implements</span> <span class="title class_">Condition</span>, java.io.Serializable &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1173984872572414699L</span>;</span><br><span class="line">       <span class="comment">//指向条件队列的头节点</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line">       <span class="comment">//指向条件队列的尾结点</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">	<span class="comment">//无参构造方法</span></span><br><span class="line">       <span class="keyword">public</span> <span class="title function_">ConditionObject</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">	。。。。。。</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/03/22/AQS%E6%BA%90%E7%A0%81-%E5%86%85%E9%83%A8%E7%B1%BBCondition%E7%9A%84%E7%90%86%E8%A7%A3(3)/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
	
	
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/22/AQS%E6%BA%90%E7%A0%81-%E9%87%8D%E8%A6%81%E7%9A%84%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/whole.png">
      <meta itemprop="name" content="小鲸鱼">
      <meta itemprop="description" content="凡事以理想为因,实行为过">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whole">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/22/AQS%E6%BA%90%E7%A0%81-%E9%87%8D%E8%A6%81%E7%9A%84%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">AQS源码-重要的成员方法(2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-22 18:04:15" itemprop="dateCreated datePublished" datetime="2022-03-22T18:04:15+08:00">2022-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-27 12:13:50" itemprop="dateModified" datetime="2022-03-27T12:13:50+08:00">2022-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JUC/" itemprop="url" rel="index"><span itemprop="name">JUC</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="从acquire方法-线程竞争获取资源"><a href="#从acquire方法-线程竞争获取资源" class="headerlink" title="从acquire方法(线程竞争获取资源)"></a>从acquire方法(线程竞争获取资源)</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//* Attempts to acquire in exclusive mode.（tryAcquire方法尝试以独占方式获取锁)</span></span><br><span class="line"><span class="comment">//* Creates and enqueues node for current thread and given mode(addWaiter方法将当前线程封装成Node结点取获取锁)</span></span><br><span class="line"><span class="comment">// acquireQueued(让当前线程以自旋的方式不断的去获取锁资源,该方法还包括抢占锁资源失败后挂起当前线程、线程唤醒后相关的逻辑)</span></span><br><span class="line"><span class="comment">// selfInterrupt()中断当前线程</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">           acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">           selfInterrupt();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/03/22/AQS%E6%BA%90%E7%A0%81-%E9%87%8D%E8%A6%81%E7%9A%84%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
	
	
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/22/AQS%E6%A6%82%E8%BF%B0,%E6%9E%B6%E6%9E%84-22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/whole.png">
      <meta itemprop="name" content="小鲸鱼">
      <meta itemprop="description" content="凡事以理想为因,实行为过">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whole">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/22/AQS%E6%A6%82%E8%BF%B0,%E6%9E%B6%E6%9E%84-22/" class="post-title-link" itemprop="url">AQS概述、体系架构、属性分析(1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-22 18:04:15" itemprop="dateCreated datePublished" datetime="2022-03-22T18:04:15+08:00">2022-03-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-27 12:13:29" itemprop="dateModified" datetime="2022-03-27T12:13:29+08:00">2022-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JUC/" itemprop="url" rel="index"><span itemprop="name">JUC</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="AQS的概述"><a href="#AQS的概述" class="headerlink" title="AQS的概述"></a>AQS的概述</h2><p>AQS的全称是AbstractQueuedSynchronizer(抽象队列同步器),它是其他同步器组件的基础框架并且是整个JUC体系的基石,AQS是基于CLH（Craig、Landin 和 Hagersten）锁定队列的变体实现FIFO(双向队列),每一个抢占资源的线程被封装成了Node结点来实现对资源的分配,内部维护了一个同步状态变量status(private volatile int state),通过CAS的方式进行原子更新状态变量Status实现加锁解锁操作</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/03/22/AQS%E6%A6%82%E8%BF%B0,%E6%9E%B6%E6%9E%84-22/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
	
	
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小鲸鱼"
      src="/images/whole.png">
  <p class="site-author-name" itemprop="name">小鲸鱼</p>
  <div class="site-description" itemprop="description">凡事以理想为因,实行为过</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022-02 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小鲸鱼</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

  


</body>
</html>
